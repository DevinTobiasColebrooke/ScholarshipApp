<div class="max-w-4xl mx-auto py-10 px-4">
  <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-100">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
      <%= @organization.name %>
    </h1>
    <p class="text-xl text-gray-500 mb-6">EIN: <%= @organization.ein %></p>

    <% if @organization.only_contri_preselected_ind == 'X' %>
      <div class="p-5 bg-red-50 border-l-4 border-red-500 rounded-lg mb-8" role="alert">
        <div class="flex items-center">
          <svg class="h-6 w-6 text-red-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <h3 class="text-lg font-bold text-red-800">THIS FOUNDATION DOES NOT ACCEPT UNSOLICITED REQUESTS</h3>
        </div>
        <p class="text-sm text-red-700 pt-2 ml-9">
          XML filing indicates they **ONLY** make contributions to preselected charitable organizations (Part XIV, Line 2 check box is marked 'X').
        </p>
      </div>
    <% end %>
    
    <% if @organization.contributing_manager_nm.present? || @organization.shareholder_manager_nm.present? %>
      <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-t pt-6">Manager Information</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-8 border-b pb-6">
        <% if @organization.contributing_manager_nm.present? %>
          <div>
            <p class="font-semibold text-gray-700">Contributing Manager Name:</p>
            <p class="text-gray-900"><%= @organization.contributing_manager_nm %></p>
          </div>
        <% end %>
        <% if @organization.shareholder_manager_nm.present? %>
          <div>
            <p class="font-semibold text-gray-700">Shareholder Manager Name:</p>
            <p class="text-gray-900"><%= @organization.shareholder_manager_nm %></p>
          </div>
        <% end %>
      </div>
    <% end %>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-8 text-sm mb-8 border-b pb-6">
      <div class="md:col-span-2">
        <p class="font-semibold text-gray-700">Primary Exempt Purpose (From Part III):</p>
        <p class="text-gray-900 italic">
          <%= @organization.primary_exempt_purpose_txt.presence || 'Not available in filing.' %>
        </p>
      </div>
      
      <div>
        <p class="font-semibold text-gray-700">Filing Status (PF_FILING_REQ_CD):</p>
        <p class="text-gray-900"><%= @organization.pf_filing_req_cd == "1" ? "Private Foundation (990-PF)" : "Other Tax Exempt" %></p>
      </div>
      <div>
        <p class="font-semibold text-gray-700">NTEE Code (NTEE_CD):</p>
        <p class="text-gray-900"><%= @organization.ntee_code %></p>
      </div>
      <div>
        <p class="font-semibold text-gray-700">Grants to Individuals (CSV):</p>
        <p class="<%= @organization.grnt_indiv_cd == "Y" ? "text-green-600 font-medium" : "text-red-600" %>">
          <%= @organization.grnt_indiv_cd == "Y" ? "Yes" : "No" %>
        </p>
      </div>
      <div>
        <p class="font-semibold text-gray-700">Grants to Individuals (XML Confirmed):</p>
        <p class="<%= @organization.grants_to_individuals_ind == "X" ? "text-green-600 font-medium" : "text-gray-900" %>">
          <%= @organization.grants_to_individuals_ind.presence || 'No XML Confirmation' %>
        </p>
      </div>
      <div>
        <p class="font-semibold text-gray-700">Approved Future Grants (GRNTAPPRVFUT):</p>
        <p class="text-gray-900">
          <% amount = @organization.grnt_apprv_fut.to_d rescue 0 %>
          <%= amount > 0 ? number_to_currency(amount, precision: 0) : "None Reported" %>
        </p>
      </div>

      <% if @organization.website_address_txt.present? %>
        <div class="md:col-span-2">
          <p class="font-semibold text-gray-700">Website Address:</p>
          <p class="text-indigo-600 hover:text-indigo-800 break-all">
            <% url = @organization.website_address_txt %>
            <% url = "http://#{url}" unless url.start_with?('http') %>
            <%= link_to @organization.website_address_txt, url, target: "_blank", rel: "noopener" %>
          </p>
        </div>
      <% end %>
    </div>

    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Grant Application Details (Part XIV, Line 2)</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-8 border-b pb-6">
      
      <div class="p-3 bg-gray-50 rounded-lg">
        <p class="font-semibold text-gray-700">Submission Deadlines:</p>
        <p class="text-base text-gray-900"><%= @organization.submission_deadlines_txt.presence || 'Not specified in XML.' %></p>
      </div>

      <div class="p-3 bg-gray-50 rounded-lg">
        <p class="font-semibold text-gray-700">Application Materials:</p>
        <p class="text-base text-gray-900"><%= @organization.application_materials_txt.presence || 'Not specified in XML.' %></p>
      </div>

      <div class="p-3 bg-gray-50 rounded-lg">
        <p class="font-semibold text-gray-700">Restrictions on Awards:</p>
        <p class="text-base text-gray-900"><%= @organization.restrictions_on_awards_txt.presence || 'Not specified in XML.' %></p>
      </div>
      
      <% if @organization.recipient_email_address_txt.present? %>
        <div class="p-3 bg-gray-50 rounded-lg">
          <p class="font-semibold text-gray-700">Filing Email:</p>
          <p class="text-base text-gray-900"><%= mail_to @organization.recipient_email_address_txt %></p>
        </div>
      <% end %>

      <div class="p-3 bg-gray-50 rounded-lg">
        <p class="font-semibold text-gray-700">Filing Address:</p>
        <p class="text-base text-gray-900 whitespace-pre-wrap"><%= @organization.us_address.presence || 'Not available.' %></p>
      </div>
      
      <div class="p-3 bg-gray-50 rounded-lg">
        <p class="font-semibold text-gray-700">Filing Phone:</p>
        <p class="text-base text-gray-900"><%= @organization.phone_num.presence || 'Not available.' %></p>
      </div>

    </div>
    
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Financial Metrics</h2>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm mb-8 border-b pb-6">
      <div class="p-3 bg-gray-50 rounded-lg">
        <p class="font-semibold text-gray-700">Total Revenue (Part I):</p>
        <p class="text-lg font-bold text-gray-900"><%= number_to_currency(@organization.cy_total_revenue_amt, precision: 0) %></p>
      </div>
      <div class="p-3 bg-gray-50 rounded-lg">
        <p class="font-semibold text-gray-700">Qualifying Distributions (Part XI):</p>
        <p class="text-lg font-bold text-gray-900"><%= number_to_currency(@organization.qualifying_distributions_amt, precision: 0) %></p>
      </div>
      <div class="p-3 bg-gray-50 rounded-lg">
        <p class="font-semibold text-gray-700">FMV Total Assets (Index I):</p>
        <p class="text-lg font-bold text-gray-900"><%= number_to_currency(@organization.fmv_assets_eoy_amt, precision: 0) %></p>
      </div>

      <%= render 'supplemental_info', organization: @organization %>
      
      <% if @organization.approved_future_grants_xml_amt && @organization.approved_future_grants_xml_amt > 0 %>
        <div class="p-3 bg-green-50 rounded-lg sm:col-span-3">
          <p class="font-semibold text-green-700">Approved Future Grants (Part XV):</p>
          <p class="text-lg font-bold text-green-900">
            <%= number_to_currency(@organization.approved_future_grants_xml_amt, precision: 0) %>
            <span class="font-normal text-sm text-green-700">(Purpose: <%= @organization.approved_future_grants_purpose.truncate(100) %>)</span>
          </p>
        </div>
      <% end %>

      <% total_paid = @organization.total_grants_paid_xml_amt.to_d rescue 0 %>
      <% if total_paid > 0 && total_paid > @total_grants_count %>
        <div class="p-3 bg-blue-50 rounded-lg">
          <p class="font-semibold text-blue-700">Total Grants Paid (Part XIV Total):</p>
          <p class="text-lg font-bold text-blue-900">
            <%= number_to_currency(total_paid, precision: 0) %>
          </p>
        </div>
      <% end %>

      <% total_apprv_fut = @organization.total_grant_or_contri_apprv_fut_amt.to_d rescue 0 %>
      <% if total_apprv_fut > 0 && total_apprv_fut != (@organization.approved_future_grants_xml_amt.to_d rescue 0) %>
        <div class="p-3 bg-blue-50 rounded-lg">
          <p class="font-semibold text-blue-700">Total Approved Future Grants (Part XV Total):</p>
          <p class="text-lg font-bold text-blue-900">
            <%= number_to_currency(total_apprv_fut, precision: 0) %>
          </p>
        </div>
      <% end %>
      
    </div>


    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Detailed Program Services (Part III)</h2>
    <% if @program_services.any? %>
      <div class="space-y-6">
        <% @program_services.each.with_index(1) do |service, index| %>
          <div class="p-5 border border-blue-100 bg-blue-50 rounded-lg shadow-sm">
            <h4 class="text-lg font-bold text-blue-800 mb-2">Program <%= index %> (<%= service.activity_code.presence || "N/A" %>)</h4>
            
            <p class="text-sm text-gray-700 whitespace-pre-wrap mb-3">
              <%= service.description_txt %>
            </p>

            <div class="flex flex-wrap gap-x-6 text-xs text-gray-600">
              <span class="font-medium">Grants for this activity: <%= number_to_currency(service.grant_amt, precision: 0) %></span>
              <span class="font-medium">Expenses: <%= number_to_currency(service.expense_amt, precision: 0) %></span>
              <span class="font-medium">Revenue: <%= number_to_currency(service.revenue_amt, precision: 0) %></span>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-gray-500 italic mb-8">No detailed program service accomplishments found in the XML filing (Part III).</p>
    <% end %>


    <h2 class="text-2xl font-semibold text-gray-800 border-t pt-6 mt-8 mb-4">Recent Grants Paid (Part XIV, Line 3a) (Total: <%= @total_grants_count %> Found)</h2>
    
    <% if @organization_grants.any? %>
      <h3 class="text-xl font-semibold text-gray-700 mb-3 mt-6">Grants to Organizations (<%= @organization_grants.count %> Found)</h3>
      <div class="space-y-4">
        <% @organization_grants.each do |grant| %>
          <% cleaned_name = grant.recipient_business_name.to_s.upcase.strip %>
          <% recipient_org = @recipient_org_map[cleaned_name] %>
          
          <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-1">
              <h4 class="font-bold text-lg text-indigo-700">
                <%= number_to_currency(grant.amount, precision: 0) %>
              </h4>
              <span class="text-base text-gray-700 font-medium">
                Recipient: 
                <% if recipient_org %>
                  <%= link_to recipient_org.name, organization_path(recipient_org), class: "text-indigo-600 hover:underline font-bold" %>
                  <span class="text-sm text-gray-500">(<%= recipient_org.ein %>)</span>
                <% else %>
                  <%= grant.recipient_business_name.presence || "Unknown Organization" %>
                  <span class="text-sm text-gray-500">(Name not linked to organization in DB)</span>
                <% end %>
              </span>
            </div>
            
            <p class="text-sm text-gray-600 mb-2">
              **Purpose:** <%= grant.purpose_text %>
            </p>

            <div class="text-xs text-gray-500 space-y-1 mt-2">
              <% if grant.recipient_relationship_txt.present? %>
                <p><strong>Relationship:</strong> <%= grant.recipient_relationship_txt %></p>
              <% end %>
              <% if grant.recipient_foundation_status_txt.present? %>
                <p><strong>Foundation Status:</strong> <%= grant.recipient_foundation_status_txt %></p>
              <% end %>
              <% if grant.recipient_us_address.present? %>
                <p><strong>Address (US):</strong> <span class="whitespace-pre-wrap"><%= grant.recipient_us_address %></span></p>
              <% elsif grant.recipient_foreign_address.present? %>
                <p><strong>Address (Foreign):</strong> <%= grant.recipient_foreign_address.truncate(150) %></p>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-gray-500 italic mt-4">No organization grants found in the XML filing (Part XIV, Line 3a).</p>
    <% end %>

    <% if @individual_grants.any? %>
      <h3 class="text-xl font-semibold text-gray-700 mb-3 mt-8 border-t pt-4">Grants to Individuals (<%= @individual_grants.count %> Found)</h3>
      <div class="space-y-4">
        <% @individual_grants.each do |grant| %>
          <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-1">
              <h4 class="font-bold text-lg text-indigo-700">
                <%= number_to_currency(grant.amount, precision: 0) %>
              </h4>
              <span class="text-base text-gray-700 font-medium">
                Recipient: <%= grant.recipient_person_nm.presence || "Individual Recipient" %>
              </span>
            </div>
            
            <p class="text-sm text-gray-600 mb-2">
              **Purpose:** <%= grant.purpose_text %>
            </p>

            <div class="text-xs text-gray-500 space-y-1 mt-2">
              <% if grant.recipient_relationship_txt.present? %>
                <p><strong>Relationship:</strong> <%= grant.recipient_relationship_txt %></p>
              <% end %>
              <% if grant.recipient_foundation_status_txt.present? %>
                <p><strong>Foundation Status:</strong> <%= grant.recipient_foundation_status_txt %></p>
              <% end %>
              <% if grant.recipient_us_address.present? %>
                <p><strong>Address (US):</strong> <span class="whitespace-pre-wrap"><%= grant.recipient_us_address %></span></p>
              <% elsif grant.recipient_foreign_address.present? %>
                <p><strong>Address (Foreign):</strong> <%= grant.recipient_foreign_address.truncate(150) %></p>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-gray-500 italic mt-4">No individual grants found in the XML filing (Part XIV, Line 3a).</p>
    <% end %>
    
    <% if @total_grants_count == 0 && !@organization_grants.any? && !@individual_grants.any? %>
      <p class="text-gray-500 italic">No grants were found in the XML filing (Part XIV, Line 3a).</p>
    <% end %>

    <%= link_to "â† Back to Search", root_path(params.permit(:mission_query, :program_service_query, :grant_purpose_query, :scholarship_filter, :active_grantor_filter, :ntee_b82, :ntee_040, :ntee_561)), class: "mt-8 inline-block text-indigo-600 hover:underline" %>

  </div>
</div>